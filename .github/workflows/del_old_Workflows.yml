name: åˆ é™¤ Old Workflows

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´0ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼‰
    - cron: '0 0 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      workflow_title:
        description: "Workflow Title"
        required: true
        default: "Delete old workflow runs"
      retain_days:
        description: "ä¿ç•™å¤©æ•°"
        required: false
        default: "1"
      keep_minimum_runs:
        description: "æœ€å°ä¿ç•™æ•°é‡"
        required: false
        default: "6"

# ç¯å¢ƒå˜é‡é…ç½®
env:
  # ä½¿ç”¨GitHubç”Ÿæˆçš„ä»¤ç‰Œï¼Œé»˜è®¤æœ‰actions:writeæƒé™
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰çš„PATï¼ˆå¦‚æœéœ€è¦æ›´å¤šæƒé™ï¼‰
  CUSTOM_TOKEN: ${{ secrets.MIGU_TOKEN }}

jobs:
  clean_workflow_runs:
    name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•
    runs-on: ubuntu-latest
    
    # å¿…é¡»æ˜¾å¼å£°æ˜åˆ é™¤å·¥ä½œæµçš„æƒé™
    permissions:
      actions: write
      contents: read
    
    steps:
      # æ­¥éª¤1ï¼šåˆ é™¤ã€ŒNightly Buildã€å·¥ä½œæµçš„æ—§è®°å½•
      - name: åˆ é™¤ Nightly Build å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          # ä½¿ç”¨GitHubè‡ªåŠ¨ç”Ÿæˆçš„tokenï¼ˆæ¨èï¼‰
          token: ${{ env.GITHUB_TOKEN }}
          
          # æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰PATï¼ˆå¦‚æœéœ€è¦æ›´å¤šæƒé™ï¼‰
          # token: ${{ env.CUSTOM_TOKEN }}
          
          # æŒ‡å®šä»“åº“
          repository: ${{ github.repository }}
          
          # ä¿ç•™ç­–ç•¥
          retain_days: ${{ inputs.retain_days || 1 }}
          
          # æœ€å°ä¿ç•™æ•°é‡
          keep_minimum_runs: ${{ inputs.keep_minimum_runs || 6 }}
          
          # æŒ‡å®šè¦åˆ é™¤çš„å·¥ä½œæµåç§°ï¼ˆç²¾å‡†åŒ¹é…ï¼‰
          delete_workflow_pattern: 'Nightly Build'
          
          # åˆ é™¤æ‰€æœ‰çŠ¶æ€çš„è¿è¡Œè®°å½•
          delete_workflow_by_state_pattern: ALL
          delete_run_by_conclusion_pattern: ALL
          
          # åŸºç¡€URL
          baseUrl: https://api.github.com
          
          # æ˜¯å¦ä½¿ç”¨æ¯æ—¥ä¿ç•™ç­–ç•¥
          use_daily_retention: false
          
          # æµ‹è¯•æ¨¡å¼è®¾ç½®ä¸ºfalseä»¥å®é™…æ‰§è¡Œåˆ é™¤
          dry_run: false
          
          # è·³è¿‡åˆ†æ”¯å’ŒPRæ£€æŸ¥
          check_branch_existence: false
          check_pullrequest_exist: false

      # æ­¥éª¤2ï¼šåˆ é™¤å½“å‰å·¥ä½œæµè‡ªèº«çš„æ—§è®°å½•
      - name: åˆ é™¤å½“å‰å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ env.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: ${{ inputs.retain_days || 1 }}
          
          # å½“å‰å·¥ä½œæµè‡³å°‘ä¿ç•™1æ¡è®°å½•
          keep_minimum_runs: 1
          
          # åŒ¹é…å½“å‰å·¥ä½œæµåç§°
          delete_workflow_pattern: 'åˆ é™¤ Old Workflows'
          
          # å…¶ä»–é…ç½®
          delete_workflow_by_state_pattern: ALL
          delete_run_by_conclusion_pattern: ALL
          baseUrl: https://api.github.com
          use_daily_retention: false
          dry_run: false
          check_branch_existence: false
          check_pullrequest_exist: false

      # æ­¥éª¤3ï¼šéªŒè¯åˆ é™¤ç»“æœï¼ˆå¯é€‰ï¼‰
      - name: éªŒè¯æ¸…ç†ç»“æœ
        run: |
          echo "âœ… å·¥ä½œæµè¿è¡Œè®°å½•æ¸…ç†å·²å®Œæˆ"
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ”§ å·¥ä½œæµåç§°: ${{ github.workflow }}"
          echo "ğŸ“Š ä»“åº“: ${{ github.repository }}"
