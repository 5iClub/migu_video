name: update咪咕

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */2 * * *"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      USER_NAME: badboy518714
      USER_EMAIL: gougoo2010@gmail.com
      REPO_URL: github.com/5iClub/migu_video.git
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          fetch-depth: 0  # 获取完整历史记录
      
      - name: 配置 Git 身份
        run: |
          git config --local user.email "${{ env.USER_EMAIL }}"
          git config --local user.name "${{ env.USER_NAME }}"
      
      - name: 安装 Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: 加载缓存
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: 设置时区
        run: sudo timedatectl set-timezone 'Asia/Shanghai'
      
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: 执行任务
        run: |
          python MIGU.py
      
      - name: 检测文件是否更新
        id: check-updates
        run: |
          # 检查是否有文件更改
          if git diff --quiet HEAD; then
            echo "CHANGES=0" >> $GITHUB_ENV
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "没有检测到文件更改"
          else
            echo "CHANGES=1" >> $GITHUB_ENV
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "检测到文件已更改"
            git status --porcelain
          fi
      
      - name: 提交更改
        if: ${{ env.CHANGES == '1' }}
        run: |
          echo "正在提交更改..."
          # 添加所有更改的文件
          git add -A
          
          # 提交更改
          commit_msg="由 Github Actions 自动更新 - $(date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "$commit_msg" || echo "没有需要提交的更改(可能已是最新)"
          
          # 拉取最新代码并处理可能的冲突
          git pull origin main --rebase --autostash
          
      - name: 推送更改
        if: ${{ env.CHANGES == '1' }}
        run: |
          echo "正在推送更改..."
          git push origin main
        env:
          # 使用 GitHub Token 进行推送
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
